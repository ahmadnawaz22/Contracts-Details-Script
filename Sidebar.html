<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Customer Contracts</title>
    <style>
      :root {
        --pad: 12px;
        --radius: 10px;
        --muted: #666;
        --line: #eaeaea;
        --chip: #f1f5f9;
      }
      html, body { margin: 0; padding: 0; }
      body { font-family: Arial, sans-serif; padding: var(--pad); font-size: 14px; }
      h2 { margin: 0 0 12px; font-size: 16px; }

      label { font-weight: 600; display: block; margin: 6px 0 4px; }
      select, button {
        width: 100%; padding: 8px; margin: 6px 0 12px;
        border: 1px solid #ddd; border-radius: 8px; font-size: 14px;
      }
      button { cursor: pointer; background: #fff; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }

      .spinner { display: none; font-size: 12px; color: var(--muted); margin-bottom: 6px; }

      .card {
        border: 1px solid var(--line); border-radius: var(--radius);
        padding: var(--pad); margin: 10px 0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.06); background: #fff;
      }
      .muted { color: var(--muted); font-size: 12px; }

      .row { display: flex; gap: 8px; flex-wrap: wrap; }
      .row > div { flex: 1 1 140px; min-width: 140px; }

      table { width: 100%; border-collapse: collapse; margin-top: 8px; }
      th, td { border-bottom: 1px solid #eee; padding: 6px 4px; text-align: left; font-size: 13px; vertical-align: top; }
      th { background: #fafafa; }
      .right { text-align: right; }
      .total { font-weight: bold; }

      details { border-radius: var(--radius); }
      details summary { cursor: pointer; font-weight: 600; list-style: none; outline: none; }
      details summary::-webkit-details-marker { display: none; }

      .badge { display:inline-block; padding:2px 6px; border-radius:6px; background: var(--chip); font-size: 11px; }

      @media (max-width: 360px) {
        body { font-size: 13px; }
        th, td { font-size: 12px; }
      }
    </style>
  </head>
  <body>
    <h2>Customer Contracts</h2>

    <label for="customerSel">Customer</label>
    <select id="customerSel"></select>

    <button id="loadBtn" type="button">Load Contracts</button>
    <div class="spinner" id="spinner">Loading…</div>

    <div id="result" aria-live="polite"></div>

    <script>
      // Passed from Apps Script template (may be empty):
      const INITIAL_CUSTOMER = <?= JSON.stringify(initialCustomer || '') ?>;

      const fmt = {
        date(s) {
          if (!s) return "";
          const d = new Date(s);
          if (!isNaN(d)) {
            try { return d.toLocaleDateString(undefined, { day: "2-digit", month: "short", year: "2-digit" }); }
            catch (_) { return d.toDateString(); }
          }
          return s;
        },
        num(n) { return (typeof n === "number" && isFinite(n)) ? n.toLocaleString() : (n ?? ""); },
        money(n) {
          return (typeof n === "number" && isFinite(n))
            ? n.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })
            : (n ?? "");
        }
      };

      function setLoading(is) {
        document.getElementById("spinner").style.display = is ? "block" : "none";
        document.getElementById("loadBtn").disabled = is;
        document.getElementById("customerSel").disabled = is;
      }

      // Populate dropdown
      google.script.run
        .withSuccessHandler(customers => {
          const sel = document.getElementById("customerSel");
          sel.innerHTML = customers.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join("");
          if (INITIAL_CUSTOMER && customers.includes(INITIAL_CUSTOMER)) {
            sel.value = INITIAL_CUSTOMER;
            loadContracts();
          } else if (customers.length) {
            loadContracts();
          }
        })
        .withFailureHandler(err => {
          document.getElementById("result").innerHTML = `<div class="card">Error loading customers: ${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
        })
        .getCustomers();

      document.getElementById("loadBtn").addEventListener("click", loadContracts);

      function loadContracts() {
        const customer = document.getElementById("customerSel").value;
        if (!customer) return;
        setLoading(true);
        google.script.run
          .withSuccessHandler(render)
          .withFailureHandler(err => {
            setLoading(false);
            document.getElementById("result").innerHTML =
              `<div class="card">Error: ${escapeHtml(err && err.message ? err.message : String(err))}</div>`;
          })
          .getCustomerContracts(customer);
      }

      function render(data) {
        setLoading(false);
        const container = document.getElementById("result");
        if (!data || !Array.isArray(data.contracts) || data.contracts.length === 0) {
          container.innerHTML = `<div class="card">No contracts found for <b>${escapeHtml(data && data.customer ? data.customer : "")}</b>.</div>`;
          return;
        }

        const { customer, clientId, contracts, contractCount } = data;
        const parts = [];
        parts.push(`<div class="muted">
            Showing ${contractCount} contract(s) for <b>${escapeHtml(customer)}</b>
            ${clientId ? `<br><span>Client ID: ${escapeHtml(clientId)}</span>` : ``}
          </div>`);

        contracts.forEach(c => {
          const header =
            `<div class="row">
              <div><span class="badge">Orderform</span><br><b>${escapeHtml(c.orderformCode || "-")}</b></div>
              <div><span class="badge">Ref.</span><br>${escapeHtml(c.ref || "-")}</div>
              <div><span class="badge">Start</span><br>${fmt.date(c.startDate)}</div>
              <div><span class="badge">End</span><br>${fmt.date(c.endDate)}</div>
              <div><span class="badge">Payment Term</span><br>${escapeHtml(c.paymentTerm || "-")}</div>
            </div>`;

          const lines = (c.lines || []).map(l => `
            <tr>
              <td>${escapeHtml(l.subProduct || "-")}</td>
              <td>${escapeHtml(l.refValue || "-")}</td>         <!-- NEW: D Ref. per row -->
              <td class="right">${fmt.num(Number(l.licenseOrdered))}</td>
              <td class="right">${fmt.money(Number(l.price))}</td>
              <td class="right">${fmt.money(Number(l.amount))}</td>
              <td>${escapeHtml(l.comments || "")}</td>          <!-- NEW: S Comments -->
            </tr>`).join("");

          const table = `
            <table>
              <thead>
                <tr>
                  <th>SubProduct</th>
                  <th>Ref.</th>
                  <th class="right">License Ordered</th>
                  <th class="right">Price</th>
                  <th class="right">Amount</th>
                  <th>Comments</th>
                </tr>
              </thead>
              <tbody>${lines}</tbody>
              <tfoot>
                <tr class="total">
                  <td colspan="4" class="right">Contract Total</td>
                  <td class="right">${fmt.money(Number(c.totalAmount))}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>`;

          parts.push(
            `<details class="card" open>
               <summary>${escapeHtml(c.orderformCode || "-")} — ${fmt.date(c.startDate)} → ${fmt.date(c.endDate)}</summary>
               ${header}
               ${table}
             </details>`
          );
        });

        container.innerHTML = parts.join("");
      }

      function escapeHtml(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>
